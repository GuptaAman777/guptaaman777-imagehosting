<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Image Gallery - GuptaAman777</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #5865F2; /* Discord Purple */
            --background-primary: #36393F; /* Discord Dark */
            --background-secondary: #2F3136; /* Discord Darker */
            --background-tertiary: #202225; /* Discord Darkest */
            --interactive-normal: #B9BBBE;
            --interactive-hover: #DCDEE1;
            --interactive-active: #FFFFFF;
            --interactive-muted: #72767D;
            --header-primary: #FFFFFF;
            --text-normal: #DCDDDE;
            --text-muted: #96989D;
            --scrollbar-thumb: #202225;
            --scrollbar-track: #2E3338;
            --card-bg: #2F3136;
            --card-hover-bg: #32353B;
            --input-bg: #202225;
            --divider-color: #3A3D42;
            --error-color: #ED4245; /* Discord Red */

            --font-primary: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --border-radius: 5px;
            --spacing-unit: 8px;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.15);
            --transition-fast: 0.15s ease-in-out;
            --transition-base: 0.2s ease-in-out;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-primary);
            background-color: var(--background-primary);
            color: var(--text-normal);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* --- Layout --- */
        .app-container { display: flex; flex: 1; height: 100vh; }

        .sidebar {
            width: 240px;
            background-color: var(--background-secondary);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-right: 1px solid var(--divider-color);
        }
        .sidebar-header {
            padding: calc(var(--spacing-unit) * 2);
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--header-primary);
            border-bottom: 1px solid var(--divider-color);
            display: flex; align-items: center; gap: var(--spacing-unit);
        }
        .sidebar-header .logo { color: var(--primary-color); }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: var(--spacing-unit) 0; }
        .nav-section-title {
            padding: calc(var(--spacing-unit)*1.5) calc(var(--spacing-unit)*2) var(--spacing-unit);
            text-transform: uppercase; font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
        }
        .nav-item {
            display: flex; align-items: center; gap: calc(var(--spacing-unit) * 1.5);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            margin: 1px var(--spacing-unit); border-radius: var(--border-radius);
            cursor: pointer; color: var(--interactive-normal); font-size: 0.9rem;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }
        .nav-item i { width: 18px; text-align: center; margin-right: calc(var(--spacing-unit)*0.5); color: var(--text-muted); }
        .nav-item:hover { background-color: var(--background-tertiary); color: var(--interactive-hover); }
        .nav-item.active { background-color: var(--background-tertiary); color: var(--interactive-active); font-weight: 500; }
        .nav-item.active i { color: var(--interactive-active); }
        .nav-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }

        .content-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border-bottom: 1px solid var(--divider-color); flex-shrink: 0;
            background-color: var(--background-secondary); min-height: 58px;
        }
        .header-title { font-size: 1.1rem; font-weight: 500; color: var(--header-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-actions { display: flex; align-items: center; gap: calc(var(--spacing-unit) * 2); }
        .search-container { position: relative; }
        .search-input {
            background-color: var(--input-bg); border: 1px solid var(--divider-color);
            border-radius: var(--border-radius); padding: calc(var(--spacing-unit)*0.75) var(--spacing-unit) calc(var(--spacing-unit)*0.75) calc(var(--spacing-unit)*3.5);
            color: var(--text-normal); width: 220px; transition: border-color var(--transition-base);
        }
        .search-input:focus { outline: none; border-color: var(--primary-color); }
        .search-icon { position: absolute; left: var(--spacing-unit); top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        .action-button {
            background: none; border: none; color: var(--interactive-normal); font-size: 1.1rem;
            cursor: pointer; padding: var(--spacing-unit); border-radius: var(--border-radius);
            transition: color var(--transition-fast), background-color var(--transition-fast);
        }
        .action-button:hover { color: var(--interactive-hover); background-color: var(--background-tertiary); }

        /* --- Gallery Content --- */
        .gallery-content { flex-grow: 1; overflow-y: auto; padding: calc(var(--spacing-unit) * 2); position: relative; }
        .status-indicator {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: var(--spacing-unit) * 4; color: var(--text-muted);
            background-color: rgba(54, 57, 63, 0.9); z-index: 10; border-radius: var(--border-radius);
        }
        .status-indicator i { font-size: 2.5rem; margin-bottom: var(--spacing-unit) * 2; }
        .status-indicator .error-icon { color: var(--error-color); }
        .spinner {
             width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.1);
             border-radius: 50%; border-left-color: var(--primary-color);
             animation: spin 1s linear infinite; margin-bottom: var(--spacing-unit) * 2;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: calc(var(--spacing-unit) * 2); }
        .image-card {
            background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden;
            box-shadow: var(--card-shadow); cursor: pointer; transition: transform var(--transition-base);
            position: relative;
        }
        .image-card:hover { transform: translateY(-2px); background-color: var(--card-hover-bg); }
        .image-container {
            position: relative; padding-top: 75%; /* 4:3 aspect ratio */
            background-color: var(--background-tertiary); overflow: hidden;
        }
        .image-container img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transition: transform 0.3s ease;
        }
        .image-card:hover .image-container img { transform: scale(1.05); }
        .image-info { padding: var(--spacing-unit); }
        .image-name { font-weight: 500; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--header-primary); }
        .image-meta { color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; text-transform: uppercase; }

        /* --- Modal --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.85); z-index: 1000;
            opacity: 0; transition: opacity var(--transition-base);
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content {
            background-color: var(--background-secondary); border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); display: flex; flex-direction: column;
            max-width: 85vw; max-height: 85vh; width: auto; height: auto; /* Adjust dynamically */
            overflow: hidden; transform: scale(0.95); transition: transform var(--transition-base);
        }
        .modal-overlay.show .modal-content { transform: scale(1); }

        .modal-header {
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--divider-color); flex-shrink: 0;
        }
        .modal-title { font-weight: 600; color: var(--header-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal-actions { display: flex; gap: var(--spacing-unit); }
        .modal-action-btn {
            background: none; border: none; color: var(--interactive-normal); font-size: 1rem;
            padding: calc(var(--spacing-unit) * 0.75); border-radius: 50%; cursor: pointer;
            transition: color var(--transition-fast), background-color var(--transition-fast);
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
        }
        .modal-action-btn:hover { color: var(--interactive-hover); background-color: var(--background-tertiary); }

        .modal-body {
            flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center;
            padding: var(--spacing-unit); /* Add some padding around the image */
             background-color: var(--background-primary); /* Match content area bg */
             min-height: 200px; /* Ensure body has some size */
        }
        .modal-body img {
            display: block; max-width: 100%; max-height: 100%; object-fit: contain;
            height: auto; /* Let height adjust based on width */
            width: auto; /* Let width adjust based on height */
        }
        .modal-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            left: var(--spacing-unit); right: var(--spacing-unit);
            display: flex; justify-content: space-between; pointer-events: none;
        }
        .nav-button {
            background-color: rgba(0, 0, 0, 0.5); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1rem;
            cursor: pointer; pointer-events: auto; opacity: 0.7;
            transition: opacity var(--transition-fast), background-color var(--transition-fast);
        }
        .nav-button:hover { opacity: 1; background-color: rgba(0, 0, 0, 0.7); }
        .nav-button:disabled { opacity: 0.3; cursor: default; background-color: rgba(0, 0, 0, 0.3); }

        /* --- Toast --- */
        .toast {
            position: fixed; bottom: calc(var(--spacing-unit) * 3); right: calc(var(--spacing-unit) * 3);
            background-color: var(--background-tertiary); color: var(--text-normal);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius); font-size: 0.9rem; z-index: 2000;
            opacity: 0; transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background-color: var(--error-color); color: white; }

         /* --- Responsive Refinements --- */
         @media (max-width: 768px) {
            .sidebar { display: none; /* Simplify for mobile: remove sidebar */ }
             .content-header { padding: var(--spacing-unit); }
             .search-input { width: 150px; }
             .image-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: var(--spacing-unit); }
             .gallery-content { padding: var(--spacing-unit); }
              .modal-content { max-width: 95vw; max-height: 90vh; }
              .modal-body img { /* Ensure image doesn't overflow modal body padding */
                 max-width: calc(100% - 2 * var(--spacing-unit));
                 max-height: calc(100% - 2 * var(--spacing-unit));
              }
             .nav-button { width: 35px; height: 35px; }
             /* Simple mobile nav could be added here if needed later */
         }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-images logo"></i>
                <span>Image Viewer</span>
            </div>
            <div class="sidebar-content">
                <div class="nav-section">
                    <div class="nav-item active" id="nav-all-images">
                        <i class="fas fa-grip-horizontal"></i>
                        <span class="nav-text">All Images</span>
                    </div>
                    <!-- Favorites can be added later if needed -->
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Folders</div>
                    <div id="folder-list">
                        <!-- Folder items will be added dynamically -->
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="content-area">
            <header class="content-header">
                <div class="header-title" id="headerTitle">All Images</div>
                <div class="header-actions">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Search by name..." id="searchInput">
                    </div>
                    <button class="action-button" id="refreshBtn" title="Refresh Images">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </header>

            <div class="gallery-content">
                 <!-- Status Indicators -->
                 <div class="status-indicator" id="loadingIndicator" style="display: none;">
                     <div class="spinner"></div>
                     <span id="loadingMessage">Loading images...</span>
                 </div>
                 <div class="status-indicator" id="errorIndicator" style="display: none;">
                      <i class="fas fa-exclamation-triangle error-icon"></i>
                     <p>Error Loading Images</p>
                     <span id="errorMessage" style="font-size: 0.8rem; margin-top: 5px;"></span>
                 </div>
                <div class="status-indicator" id="noResultsIndicator" style="display: none;">
                     <i class="fas fa-search"></i>
                     <p>No Images Found</p>
                      <span id="noResultsMessage" style="font-size: 0.8rem; margin-top: 5px;"></span>
                 </div>

                <!-- Image Grid -->
                <div class="image-grid" id="imageGrid">
                    <!-- Image cards added here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Image Modal -->
    <div class="modal-overlay" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Image Title</span>
                <div class="modal-actions">
                     <button class="modal-action-btn" id="modalCopyUrlBtn" title="Copy Image URL">
                         <i class="fas fa-link"></i>
                     </button>
                     <button class="modal-action-btn" id="modalDownloadBtn" title="Download Image">
                          <i class="fas fa-download"></i>
                      </button>
                     <button class="modal-action-btn" id="closeModalBtn" title="Close">
                         <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="Full Size Image">
                 <div class="modal-nav">
                    <button class="nav-button" id="prevImageBtn" title="Previous Image"><i class="fas fa-chevron-left"></i></button>
                    <button class="nav-button" id="nextImageBtn" title="Next Image"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Toast Message</div>

    <script>
        // --- Configuration ---
        const GITHUB_USERNAME = 'GuptaAman777';
        const GITHUB_REPO = 'guptaaman777-imagehosting';
        const BRANCH = 'main';
        const API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/git/trees/${BRANCH}?recursive=1`;
        const IMAGE_EXTENSIONS = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'ico'];

        // --- State ---
        let allImages = [];           // Raw data from API
        let displayedImages = [];     // Images currently shown after filtering/search
        let topLevelFolders = [];     // List of unique top-level folder names
        let currentView = { type: 'all', value: null }; // { type: 'all' } or { type: 'folder', value: 'foldername' }
        let currentSearchTerm = '';
        let currentModalIndex = -1;
        let toastTimeout = null;

        // --- DOM Elements ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const sidebar = $('.sidebar'); // Needed? Only if hiding/showing on mobile
        const folderListContainer = $('#folder-list');
        const navAllImages = $('#nav-all-images');
        const headerTitle = $('#headerTitle');
        const searchInput = $('#searchInput');
        const refreshBtn = $('#refreshBtn');
        const galleryContent = $('.gallery-content');
        const imageGrid = $('#imageGrid');
        const loadingIndicator = $('#loadingIndicator');
        const loadingMessage = $('#loadingMessage');
        const errorIndicator = $('#errorIndicator');
        const errorMessage = $('#errorMessage');
        const noResultsIndicator = $('#noResultsIndicator');
        const noResultsMessage = $('#noResultsMessage');

        const imageModal = $('#imageModal');
        const modalTitle = $('#modalTitle');
        const modalImage = $('#modalImage');
        const prevImageBtn = $('#prevImageBtn');
        const nextImageBtn = $('#nextImageBtn');
        const closeModalBtn = $('#closeModalBtn');
        const modalCopyUrlBtn = $('#modalCopyUrlBtn');
        const modalDownloadBtn = $('#modalDownloadBtn');

        const toast = $('#toast');

        // --- API & Data Handling ---
        async function fetchImageData() {
            showLoading('Fetching image list...');
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    if (response.status === 404) throw new Error(`Repository or branch not found.`);
                    if (response.status === 403) throw new Error(`API rate limit likely exceeded. Wait a moment.`);
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                if (!data.tree) throw new Error("Invalid data structure from API.");

                const uniqueFolders = new Set();
                allImages = data.tree
                    .filter(item => item.type === 'blob' && isImageFile(item.path))
                    .map(item => {
                        const pathParts = item.path.split('/');
                        const name = pathParts.pop();
                        const folder = pathParts.length > 0 ? pathParts[0] : null; // Top-level folder only
                        if (folder) uniqueFolders.add(folder);
                        return {
                            path: item.path,
                            name: name,
                            sha: item.sha,
                            size: item.size || 0, // May not be accurate from tree API
                            rawUrl: createRawUrl(item.path),
                            folder: folder,
                            extension: name.split('.').pop()?.toLowerCase() || ''
                        };
                    });

                topLevelFolders = Array.from(uniqueFolders).sort();
                console.log(`Fetched ${allImages.length} images, ${topLevelFolders.length} top-level folders.`);
                 hideStatusIndicators();
                 return true; // Indicate success

            } catch (error) {
                console.error("Fetch error:", error);
                showError(error.message);
                 return false; // Indicate failure
            }
        }

        function isImageFile(filePath) {
            const ext = filePath.split('.').pop()?.toLowerCase();
            return ext ? IMAGE_EXTENSIONS.includes(ext) : false;
        }

        function createRawUrl(path) {
            const encodedPath = path.split('/').map(segment => encodeURIComponent(decodeURIComponent(segment))).join('/');
            return `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${BRANCH}/${encodedPath}`;
        }

        // --- UI Rendering ---
        function buildSidebar() {
            folderListContainer.innerHTML = ''; // Clear old list
            topLevelFolders.forEach(folder => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.dataset.folder = folder;
                div.innerHTML = `
                    <i class="fas fa-folder"></i>
                    <span class="nav-text">${folder}</span>
                `;
                div.addEventListener('click', () => setActiveView('folder', folder));
                folderListContainer.appendChild(div);
            });
        }

        function setActiveView(type, value = null) {
            currentView = { type, value };
            currentSearchTerm = ''; // Reset search on view change
            searchInput.value = '';

             // Update header title
             headerTitle.textContent = type === 'folder' ? value : 'All Images';

             // Update sidebar active class
             $$('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
             if (type === 'all') {
                 navAllImages.classList.add('active');
             } else if (type === 'folder') {
                const folderItem = folderListContainer.querySelector(`.nav-item[data-folder="${value}"]`);
                if (folderItem) folderItem.classList.add('active');
             }

             filterAndRenderImages();
             galleryContent.scrollTop = 0; // Scroll to top of gallery
        }

        function filterAndRenderImages() {
             let imagesToFilter = allImages;

             // 1. Filter by current view (folder or all)
             if (currentView.type === 'folder') {
                 imagesToFilter = allImages.filter(img => img.folder === currentView.value);
             } // 'all' uses allImages

             // 2. Filter by search term
             if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                 imagesToFilter = imagesToFilter.filter(img => img.name.toLowerCase().includes(searchTermLower));
             }

             displayedImages = imagesToFilter;
             renderGrid();
        }

        function renderGrid() {
             hideStatusIndicators(); // Clear any previous status
            imageGrid.innerHTML = ''; // Clear previous content

            if (displayedImages.length === 0) {
                 let reason = "No images found";
                 if (currentView.type === 'folder') reason += ` in folder "${currentView.value}"`;
                 if (currentSearchTerm) reason += ` matching "${currentSearchTerm}"`;
                 showNoResults(reason + ".");
                 return;
            }

            const fragment = document.createDocumentFragment();
            displayedImages.forEach((image, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.dataset.index = index;
                card.innerHTML = `
                    <div class="image-container">
                        <img src="${image.rawUrl}" alt="${image.name}" loading="lazy" onerror="this.style.visibility='hidden';">
                    </div>
                    <div class="image-info">
                        <div class="image-name">${image.name}</div>
                        <div class="image-meta">${image.extension}</div>
                    </div>
                `;
                 // Add listener directly here for simplicity
                card.addEventListener('click', () => openModal(index));
                fragment.appendChild(card);
            });
            imageGrid.appendChild(fragment);
        }

        // --- Modal ---
        function openModal(index) {
             if (index < 0 || index >= displayedImages.length) return;
             currentModalIndex = index;
             const image = displayedImages[index];

            modalImage.src = image.rawUrl; // Start loading
            modalImage.alt = image.name;
            modalTitle.textContent = image.name;

             // Set up action button data/listeners
            modalDownloadBtn.onclick = () => downloadImage(image.rawUrl, image.name);
            modalCopyUrlBtn.onclick = () => copyUrl(image.rawUrl);

             // Update nav buttons
             prevImageBtn.disabled = index === 0;
             nextImageBtn.disabled = index === displayedImages.length - 1;

             imageModal.classList.add('show');
             document.body.style.overflow = 'hidden'; // Prevent body scroll
        }

        function closeModal() {
            imageModal.classList.remove('show');
            document.body.style.overflow = ''; // Restore body scroll
             // Optional: clear src after fade out to prevent brief flash
             setTimeout(() => { modalImage.src = ""; }, 200);
        }

        function navigateModal(direction) {
            const newIndex = currentModalIndex + direction;
            if (newIndex >= 0 && newIndex < displayedImages.length) {
                 openModal(newIndex);
            }
        }

        // --- Actions (Download, Copy) ---
         function downloadImage(url, filename) {
            try {
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 a.target = '_blank'; // Good fallback for browsers restricting direct downloads
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 showToast(`Downloading ${filename}...`);
             } catch (error) {
                 console.error("Download error:", error);
                 showToast("Download failed.", true);
             }
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Image URL copied to clipboard!');
            }).catch(err => {
                 console.error('Failed to copy URL: ', err);
                showToast('Failed to copy URL.', true);
            });
         }

        // --- Status Indicators ---
         function showLoading(message = 'Loading...') {
             hideStatusIndicators(); // Hide others first
             loadingMessage.textContent = message;
             loadingIndicator.style.display = 'flex';
             imageGrid.style.display = 'none'; // Hide grid
         }
         function showError(msg) {
             hideStatusIndicators();
             errorMessage.textContent = msg;
             errorIndicator.style.display = 'flex';
              imageGrid.style.display = 'none';
         }
         function showNoResults(msg) {
             hideStatusIndicators();
             noResultsMessage.textContent = msg;
             noResultsIndicator.style.display = 'flex';
              imageGrid.style.display = 'none';
         }
         function hideStatusIndicators() {
            loadingIndicator.style.display = 'none';
            errorIndicator.style.display = 'none';
             noResultsIndicator.style.display = 'none';
             imageGrid.style.display = 'grid'; // Show grid
         }


        // --- Toast Notifications ---
         function showToast(message, isError = false) {
             if (toastTimeout) clearTimeout(toastTimeout);
             toast.textContent = message;
             toast.className = `toast ${isError ? 'error' : ''} show`;
             toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

         // --- Debounce ---
         function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => {
                     clearTimeout(timeout);
                     func(...args);
                 };
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
             };
         }


        // --- Initialization ---
        const handleSearchInput = debounce(() => {
             currentSearchTerm = searchInput.value.trim();
             filterAndRenderImages();
         }, 300);


        async function initializeApp() {
            // Initial setup
             searchInput.addEventListener('input', handleSearchInput);
             refreshBtn.addEventListener('click', initializeApp); // Re-run the init process
            navAllImages.addEventListener('click', () => setActiveView('all'));

             // Modal Listeners
            closeModalBtn.addEventListener('click', closeModal);
             prevImageBtn.addEventListener('click', () => navigateModal(-1));
             nextImageBtn.addEventListener('click', () => navigateModal(1));
            imageModal.addEventListener('click', (e) => { // Close on overlay click
                if (e.target === imageModal) closeModal();
             });

            // Keyboard listener for modal navigation
            document.addEventListener('keydown', (e) => {
                if (imageModal.classList.contains('show')) {
                    switch (e.key) {
                        case 'Escape': closeModal(); break;
                        case 'ArrowLeft': if (!prevImageBtn.disabled) navigateModal(-1); break;
                         case 'ArrowRight': if (!nextImageBtn.disabled) navigateModal(1); break;
                     }
                 }
             });

            // Fetch data and render
             if (await fetchImageData()) {
                 buildSidebar();
                 setActiveView('all'); // Start in 'all images' view
             } // Error handling is done within fetchImageData
        }

        // --- Start the App ---
        window.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>